#
# SORT-NEST WITH SEMI JOINS
#

# MERGED SEMI-JOINS

# SEMI JOIN MATERIALIZATION SCAN with SORT-NEST
set use_sort_nest=1;
create table t0(a int);
insert t0 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);
create table t1 (a int, b int, c int);
insert t1 select A.a+B.a*10+C.a*100, A.a+B.a*10+C.a*100, A.a+B.a*10+C.a*100 from t0 A, t0 B, t0 C;
create table t2 (a int, b int, c int);
insert t2 select a,a,a from t0;
create table t3 (a int, b int, c int, key(a));
insert t3 select a,a,a from t0;
create table t4 (a int, b int, c int, key(a));
insert t4 select a,a,a from t0;
# SJM scan inside the sort-nest
# sort-nest includes (<subqery2>, t2)
explain SELECT t1.a, t2.a, t1.b,t2.b 
FROM t1, t2 
WHERE t1.a=t2.a and
t1.b in (select t3.b from t3,t4 where t3.a < 3 and t3.a=t4.a) 
ORDER BY t1.b desc ,t2.b desc
LIMIT 5;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	<subquery2>	ALL	distinct_key	NULL	NULL	NULL	3	
1	PRIMARY	t2	ALL	NULL	NULL	NULL	NULL	10	Using join buffer (flat, BNL join)
1	PRIMARY	<sort-nest>	ALL	NULL	NULL	NULL	NULL	1	Using filesort
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	1000	Using where
2	MATERIALIZED	t4	range	a	a	5	NULL	3	Using where; Using index
2	MATERIALIZED	t3	ref	a	a	5	test.t4.a	1	
explain format=json SELECT t1.a, t2.a, t1.b,t2.b 
FROM t1, t2 
WHERE t1.a=t2.a and
t1.b in (select t3.b from t3,t4 where t3.a < 3 and t3.a=t4.a) 
ORDER BY t1.b desc ,t2.b desc
LIMIT 5;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "table": {
      "table_name": "<subquery2>",
      "access_type": "ALL",
      "possible_keys": ["distinct_key"],
      "rows": 3,
      "filtered": 100,
      "materialized": {
        "unique": 1,
        "query_block": {
          "select_id": 2,
          "table": {
            "table_name": "t4",
            "access_type": "range",
            "possible_keys": ["a"],
            "key": "a",
            "key_length": "5",
            "used_key_parts": ["a"],
            "rows": 3,
            "filtered": 100,
            "attached_condition": "t4.a < 3 and t4.a is not null",
            "using_index": true
          },
          "table": {
            "table_name": "t3",
            "access_type": "ref",
            "possible_keys": ["a"],
            "key": "a",
            "key_length": "5",
            "used_key_parts": ["a"],
            "ref": ["test.t4.a"],
            "rows": 1,
            "filtered": 100
          }
        }
      }
    },
    "block-nl-join": {
      "table": {
        "table_name": "t2",
        "access_type": "ALL",
        "rows": 10,
        "filtered": 100
      },
      "buffer_type": "flat",
      "buffer_size": "184",
      "join_type": "BNL"
    },
    "read_sorted_file": {
      "filesort": {
        "sort_key": "`sort-nest`.b desc, `sort-nest`.b desc",
        "table": {
          "table_name": "<sort-nest>",
          "access_type": "ALL",
          "rows": 1,
          "filtered": 100
        }
      }
    },
    "table": {
      "table_name": "t1",
      "access_type": "ALL",
      "rows": 1000,
      "filtered": 100,
      "attached_condition": "t1.a = `sort-nest`.a and t1.b = `sort-nest`.b"
    }
  }
}
SELECT t1.a, t2.a, t1.b,t2.b 
FROM t1, t2 
WHERE t1.a=t2.a and
t1.b in (select t3.b from t3,t4 where t3.a < 3 and t3.a=t4.a) 
ORDER BY t1.b desc ,t2.b desc
LIMIT 5;
a	a	b	b
2	2	2	2
1	1	1	1
0	0	0	0
drop table t0,t1,t2,t3,t4;
#
# SEMI JOIN MATERIALIZATION LOOKUP with SORT-NEST
#
create table t0(a int);
insert t0 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);
create table t1 (a int, b int, c int, key(a));
insert t1 select A.a+B.a*10+C.a*100, A.a+B.a*10+C.a*100, A.a+B.a*10+C.a*100 from t0 A, t0 B, t0 C;
create table t2 (a int, b int, c int, key(c));
insert t2 select A.a+B.a*10, A.a+B.a*10, A.a+B.a*10 from t0 A, t0 B;
create table t3 (a int, b int, c int, key(a));
insert t3 select a,a,a from t0;
create table t4 (a int, b int, c int);
insert t4 select A.a+B.a*10, A.a+B.a*10, A.a+B.a*10 from t0 A, t0 B;
explain SELECT t1.a as w, t2.b as x, ot1.a as y, ot1.b as z
FROM t1, t2, t2 ot1
WHERE ot1.a in (select it.b from t1 it)
AND t1.a < 5
AND t1.a= ot1.b
AND t2.c < 5
ORDER BY ot1.a desc, t2.b desc
LIMIT 5;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t2	range	c	c	5	NULL	3	Using index condition
1	PRIMARY	ot1	ALL	NULL	NULL	NULL	NULL	100	Using where; Using join buffer (flat, BNL join)
1	PRIMARY	<sort-nest>	ALL	NULL	NULL	NULL	NULL	5	Using filesort
1	PRIMARY	t1	ref	a	a	5	sort-nest.b	1	Using index
1	PRIMARY	<subquery2>	eq_ref	distinct_key	distinct_key	4	func	1	
2	MATERIALIZED	it	ALL	NULL	NULL	NULL	NULL	1000	
explain format=json SELECT t1.a as w, t2.b as x, ot1.a as y, ot1.b as z
FROM t1, t2, t2 ot1
WHERE ot1.a in (select it.b from t1 it)
AND t1.a < 5
AND t1.a= ot1.b
AND t2.c < 5
ORDER BY ot1.a desc, t2.b desc
LIMIT 5;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "table": {
      "table_name": "t2",
      "access_type": "range",
      "possible_keys": ["c"],
      "key": "c",
      "key_length": "5",
      "used_key_parts": ["c"],
      "rows": 3,
      "filtered": 100,
      "index_condition": "t2.c < 5"
    },
    "block-nl-join": {
      "table": {
        "table_name": "ot1",
        "access_type": "ALL",
        "rows": 100,
        "filtered": 100
      },
      "buffer_type": "flat",
      "buffer_size": "119",
      "join_type": "BNL",
      "attached_condition": "ot1.b < 5"
    },
    "read_sorted_file": {
      "filesort": {
        "sort_key": "`sort-nest`.a desc, `sort-nest`.b desc",
        "table": {
          "table_name": "<sort-nest>",
          "access_type": "ALL",
          "rows": 5,
          "filtered": 100
        }
      }
    },
    "table": {
      "table_name": "t1",
      "access_type": "ref",
      "possible_keys": ["a"],
      "key": "a",
      "key_length": "5",
      "used_key_parts": ["a"],
      "ref": ["sort-nest.b"],
      "rows": 1,
      "filtered": 100,
      "using_index": true
    },
    "table": {
      "table_name": "<subquery2>",
      "access_type": "eq_ref",
      "possible_keys": ["distinct_key"],
      "key": "distinct_key",
      "key_length": "4",
      "used_key_parts": ["b"],
      "ref": ["func"],
      "rows": 1,
      "filtered": 100,
      "materialized": {
        "unique": 1,
        "query_block": {
          "select_id": 2,
          "table": {
            "table_name": "it",
            "access_type": "ALL",
            "rows": 1000,
            "filtered": 100
          }
        }
      }
    }
  }
}
SELECT t1.a as w, t2.b as x, ot1.a as y, ot1.b as z
FROM t1, t2, t2 ot1
WHERE ot1.a in (select it.b from t1 it)
AND t1.a < 5
AND t1.a= ot1.b
AND t2.c < 5
ORDER BY ot1.a desc, t2.b desc
LIMIT 5;
w	x	y	z
4	4	4	4
4	3	4	4
4	2	4	4
4	1	4	4
4	0	4	4
drop table t0,t1,t2,t3,t4;
#
# Firstmatch strategy
#
create table t0(a int);
insert t0 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);
create table t1 (a int, b int, c int, key(a));
insert t1 select a,a,a from t0;
create table t2 as select * from t1;
create table t3 as select * from t1;
explain select * from t1, t2 where t1.a=t2.a and
t1.b in (select b from t3 where t3.c<=t2.c) order by t2.c desc, t1.c desc limit 5;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t2	ALL	NULL	NULL	NULL	NULL	10	Using where
1	PRIMARY	t1	ref	a	a	5	test.t2.a	1	
1	PRIMARY	<sort-nest>	ALL	NULL	NULL	NULL	NULL	5	Using filesort
1	PRIMARY	t3	ALL	NULL	NULL	NULL	NULL	10	Using where; FirstMatch(<sort-nest>)
explain format=json select * from t1, t2 where t1.a=t2.a and
t1.b in (select b from t3 where t3.c<=t2.c) order by t2.c desc, t1.c desc limit 5;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "table": {
      "table_name": "t2",
      "access_type": "ALL",
      "rows": 10,
      "filtered": 100,
      "attached_condition": "t2.a is not null"
    },
    "table": {
      "table_name": "t1",
      "access_type": "ref",
      "possible_keys": ["a"],
      "key": "a",
      "key_length": "5",
      "used_key_parts": ["a"],
      "ref": ["test.t2.a"],
      "rows": 1,
      "filtered": 100
    },
    "read_sorted_file": {
      "filesort": {
        "sort_key": "`sort-nest`.c desc, `sort-nest`.c desc",
        "table": {
          "table_name": "<sort-nest>",
          "access_type": "ALL",
          "rows": 5,
          "filtered": 100
        }
      }
    },
    "table": {
      "table_name": "t3",
      "access_type": "ALL",
      "rows": 10,
      "filtered": 100,
      "attached_condition": "t3.b = `sort-nest`.b and t3.c <= `sort-nest`.c",
      "first_match": "<sort-nest>"
    }
  }
}
select * from t1, t2 where t1.a=t2.a and
t1.b in (select b from t3 where t3.c<=t2.c) order by t2.c desc, t1.c desc limit 5;
a	b	c	a	b	c
9	9	9	9	9	9
8	8	8	8	8	8
7	7	7	7	7	7
6	6	6	6	6	6
5	5	5	5	5	5
set optimizer_switch='firstmatch=off';
#
# Duplicate Weedout strategy
#
explain select * from t1, t2 where t1.a=t2.a and
t1.b in (select b from t3 where t3.c<=t2.c) order by t2.c desc, t1.c desc limit 5;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t2	ALL	NULL	NULL	NULL	NULL	10	Using where
1	PRIMARY	t1	ref	a	a	5	test.t2.a	1	
1	PRIMARY	<sort-nest>	ALL	NULL	NULL	NULL	NULL	5	Using filesort
1	PRIMARY	t3	ALL	NULL	NULL	NULL	NULL	10	Using where; Start temporary; End temporary
explain format=json select * from t1, t2 where t1.a=t2.a and
t1.b in (select b from t3 where t3.c<=t2.c) order by t2.c desc, t1.c desc limit 5;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "table": {
      "table_name": "t2",
      "access_type": "ALL",
      "rows": 10,
      "filtered": 100,
      "attached_condition": "t2.a is not null"
    },
    "table": {
      "table_name": "t1",
      "access_type": "ref",
      "possible_keys": ["a"],
      "key": "a",
      "key_length": "5",
      "used_key_parts": ["a"],
      "ref": ["test.t2.a"],
      "rows": 1,
      "filtered": 100
    },
    "read_sorted_file": {
      "filesort": {
        "sort_key": "`sort-nest`.c desc, `sort-nest`.c desc",
        "table": {
          "table_name": "<sort-nest>",
          "access_type": "ALL",
          "rows": 5,
          "filtered": 100
        }
      }
    },
    "duplicates_removal": {
      "table": {
        "table_name": "t3",
        "access_type": "ALL",
        "rows": 10,
        "filtered": 100,
        "attached_condition": "t3.b = `sort-nest`.b and t3.c <= `sort-nest`.c"
      }
    }
  }
}
select * from t1, t2 where t1.a=t2.a and
t1.b in (select b from t3 where t3.c<=t2.c) order by t2.c desc, t1.c desc limit 5;
a	b	c	a	b	c
9	9	9	9	9	9
8	8	8	8	8	8
7	7	7	7	7	7
6	6	6	6	6	6
5	5	5	5	5	5
set optimizer_switch=default;
drop table t0,t1,t2,t3;

# NON-MERGED SEMI JOINS

create table t0 (a int);
insert into t0 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);
create table t1 (a int, b int);
insert into t1 select a,a from t0 where a <5;
create table t2 as select * from t1 where a < 5;
create table t3(a int, b int);
insert into t3 select A.a + 10*B.a, A.a + 10*B.a from t0 A, t0 B;
<subquery2> outside the sort-nest
EXPLAIN SELECT * from t2,t1
WHERE t2.b=t1.b
AND
t1.a IN (select max(t3.a) FROM t3 GROUP BY t3.b)
ORDER BY t2.a desc,t1.a desc
LIMIT 5;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t2	ALL	NULL	NULL	NULL	NULL	5	
1	PRIMARY	t1	ALL	NULL	NULL	NULL	NULL	5	Using where; Using join buffer (flat, BNL join)
1	PRIMARY	<sort-nest>	ALL	NULL	NULL	NULL	NULL	5	Using filesort
1	PRIMARY	<subquery2>	eq_ref	distinct_key	distinct_key	4	sort-nest.a	1	
2	MATERIALIZED	t3	ALL	NULL	NULL	NULL	NULL	100	Using temporary
EXPLAIN FORMAT=JSON SELECT * from t2,t1
WHERE t2.b=t1.b
AND
t1.a IN (select max(t3.a) FROM t3 GROUP BY t3.b)
ORDER BY t2.a desc,t1.a desc
LIMIT 5;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "table": {
      "table_name": "t2",
      "access_type": "ALL",
      "rows": 5,
      "filtered": 100
    },
    "block-nl-join": {
      "table": {
        "table_name": "t1",
        "access_type": "ALL",
        "rows": 5,
        "filtered": 100
      },
      "buffer_type": "flat",
      "buffer_size": "119",
      "join_type": "BNL",
      "attached_condition": "t1.b = t2.b"
    },
    "read_sorted_file": {
      "filesort": {
        "sort_key": "`sort-nest`.a desc, `sort-nest`.a desc",
        "table": {
          "table_name": "<sort-nest>",
          "access_type": "ALL",
          "rows": 5,
          "filtered": 100
        }
      }
    },
    "table": {
      "table_name": "<subquery2>",
      "access_type": "eq_ref",
      "possible_keys": ["distinct_key"],
      "key": "distinct_key",
      "key_length": "4",
      "used_key_parts": ["max(t3.a)"],
      "ref": ["sort-nest.a"],
      "rows": 1,
      "filtered": 100,
      "materialized": {
        "unique": 1,
        "query_block": {
          "select_id": 2,
          "temporary_table": {
            "table": {
              "table_name": "t3",
              "access_type": "ALL",
              "rows": 100,
              "filtered": 100
            }
          }
        }
      }
    }
  }
}
SELECT * from t2,t1
WHERE t2.b=t1.b
AND
t1.a IN (select max(t3.a) FROM t3 GROUP BY t3.b)
ORDER BY t2.a desc,t1.a desc
LIMIT 5;
a	b	a	b
4	4	4	4
3	3	3	3
2	2	2	2
1	1	1	1
0	0	0	0
<subquery2> inside the sort-nest
EXPLAIN SELECT * FROM t3,t2
WHERE t3.b=t2.b AND
t3.a IN (select max(t1.a) FROM t1 GROUP BY t1.b)
ORDER BY t3.a desc,t2.a desc
LIMIT 5;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	PRIMARY	t2	ALL	NULL	NULL	NULL	NULL	5	
1	PRIMARY	<subquery2>	ALL	distinct_key	NULL	NULL	NULL	5	Using join buffer (flat, BNL join)
1	PRIMARY	<sort-nest>	ALL	NULL	NULL	NULL	NULL	1	Using filesort
1	PRIMARY	t3	ALL	NULL	NULL	NULL	NULL	100	Using where
2	MATERIALIZED	t1	ALL	NULL	NULL	NULL	NULL	5	Using temporary
EXPLAIN FORMAT=JSON SELECT * FROM t3,t2
WHERE t3.b=t2.b AND
t3.a IN (select max(t1.a) FROM t1 GROUP BY t1.b)
ORDER BY t3.a desc,t2.a desc
LIMIT 5;
EXPLAIN
{
  "query_block": {
    "select_id": 1,
    "table": {
      "table_name": "t2",
      "access_type": "ALL",
      "rows": 5,
      "filtered": 100
    },
    "block-nl-join": {
      "table": {
        "table_name": "<subquery2>",
        "access_type": "ALL",
        "possible_keys": ["distinct_key"],
        "rows": 5,
        "filtered": 100
      },
      "buffer_type": "flat",
      "buffer_size": "119",
      "join_type": "BNL",
      "materialized": {
        "unique": 1,
        "query_block": {
          "select_id": 2,
          "temporary_table": {
            "table": {
              "table_name": "t1",
              "access_type": "ALL",
              "rows": 5,
              "filtered": 100
            }
          }
        }
      }
    },
    "read_sorted_file": {
      "filesort": {
        "sort_key": "`sort-nest`.`max(t1.a)` desc, `sort-nest`.a desc",
        "table": {
          "table_name": "<sort-nest>",
          "access_type": "ALL",
          "rows": 1,
          "filtered": 100
        }
      }
    },
    "table": {
      "table_name": "t3",
      "access_type": "ALL",
      "rows": 100,
      "filtered": 100,
      "attached_condition": "t3.a = `sort-nest`.`max(t1.a)` and t3.b = `sort-nest`.b"
    }
  }
}
SELECT * FROM t3,t2
WHERE t3.b=t2.b AND
t3.a IN (select max(t1.a) FROM t1 GROUP BY t1.b)
ORDER BY t3.a desc,t2.a desc
LIMIT 5;
a	b	a	b
4	4	4	4
3	3	3	3
2	2	2	2
1	1	1	1
0	0	0	0
drop table t1,t2,t3,t0;
