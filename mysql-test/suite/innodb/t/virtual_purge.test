--source include/have_innodb.inc

CREATE TABLE t1 (
  pk INT AUTO_INCREMENT,
  b BIT(15),
  v BIT(15) AS (b) VIRTUAL,
  PRIMARY KEY(pk),
  UNIQUE(v)
) ENGINE=InnoDB;
INSERT IGNORE INTO t1 (b) VALUES
  (NULL),(b'011'),(b'000110100'),
  (b'01101101010'),(b'01111001001011'),(NULL);
#set debug_dbug= "+d:f,innobase_build_v_templ,row_vers_build_clust_v_col,close_cached_tables,tdc_release_share:T:t:i:n:o,debug"
#set global innodb_debug_sync = "ib_purge_start_computing SIGNAL start_computing WAIT_FOR flush_unlock";
#set global innodb_debug_sync = "ib_purge_computing_done SIGNAL computing_done";
#set debug_sync = "after_flush_unlock SIGNAL flush_unlock WAIT_FOR computing_done";

REPLACE INTO t1 (pk, b) SELECT pk, b FROM t1;

#set debug_sync = "now WAIT_FOR start_computing";
FLUSH TABLES;
#set debug_sync = "now SIGNAL flush_done";

# Cleanup
DROP TABLE t1;
--sleep 1
